# Anki å¡ç‰‡ç”ŸæˆåŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ•°æ®åº“ Schema âœ…

å·²æ›´æ–° Prisma schemaï¼Œæ·»åŠ äº†ä»¥ä¸‹æ¨¡å‹ï¼š

- **Deck æ¨¡å‹**ï¼šç‰Œç»„ç®¡ç†
  - `id`, `userId`, `name`
  - å”¯ä¸€çº¦æŸï¼šæ¯ä¸ªç”¨æˆ·çš„ç‰Œç»„åç§°å”¯ä¸€
  - å…³è”ï¼šä¸€ä¸ªç‰Œç»„åŒ…å«å¤šå¼ å¡ç‰‡

- **Card æ¨¡å‹**ï¼šå¡ç‰‡å­˜å‚¨
  - `id`, `userId`, `deckId`
  - å¡ç‰‡å†…å®¹ï¼š`frontContent`, `backContent`, `cardType`
  - éŸ³é¢‘ç›¸å…³ï¼š`audioUrl`, `audioFilename`, `timestamps`, `kanaText`
  - å…ƒæ•°æ®ï¼š`deckName`, `tags`
  - ç´¢å¼•ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

**æ³¨æ„**ï¼šéœ€è¦è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š
```bash
npx prisma migrate dev --name add_cards_and_decks
```

### 2. LLM åˆ†æ API âœ…

**æ–‡ä»¶**ï¼š`app/api/llm/analyze/route.ts`

**åŠŸèƒ½**ï¼š
- è°ƒç”¨ DashScope Qwen-Plus æ¨¡å‹åˆ†ææ—¥æ–‡å¥å­
- ç”Ÿæˆç¿»è¯‘ã€å•è¯è§£é‡Šã€è¯­æ³•ç‚¹è§£é‡Š
- æå–å‡åæ–‡æœ¬ï¼ˆç”¨äº TTSï¼‰
- æ¶ˆè€— 2 credits

**ç¯å¢ƒå˜é‡**ï¼š
```env
DASHSCOPE_API_KEY=your-dashscope-api-key
```

### 3. å¢å¼º TTS API âœ…

**æ–‡ä»¶**ï¼š`app/api/tts/generate-enhanced/route.ts`

**åŠŸèƒ½**ï¼š
- è°ƒç”¨ DashScope Qwen-TTS ç”Ÿæˆæ—¥æ–‡å‘éŸ³
- æ”¯æŒä½¿ç”¨å‡åæ–‡æœ¬ç”Ÿæˆæ›´å‡†ç¡®çš„å‘éŸ³
- è¿”å›éŸ³é¢‘ URL
- æ¶ˆè€— 1 credit

### 4. å¡ç‰‡ç”Ÿæˆ API âœ…

**æ–‡ä»¶**ï¼š`app/api/cards/generate/route.ts`

**åŠŸèƒ½**ï¼š
- æ•´åˆ LLM åˆ†æå’Œ TTS ç”Ÿæˆ
- è‡ªåŠ¨åˆ›å»ºç‰Œç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- ä¿å­˜å¡ç‰‡åˆ°æ•°æ®åº“
- æ¶ˆè€— 3 creditsï¼ˆåŒ…å«å‘éŸ³ï¼‰æˆ– 2 creditsï¼ˆä¸åŒ…å«å‘éŸ³ï¼‰

**å…¶ä»– API**ï¼š
- `GET /api/cards` - è·å–å¡ç‰‡åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µã€ç­›é€‰ï¼‰
- `GET /api/cards/[id]` - è·å–å•ä¸ªå¡ç‰‡
- `PUT /api/cards/[id]` - æ›´æ–°å¡ç‰‡
- `DELETE /api/cards/[id]` - åˆ é™¤å¡ç‰‡
- `GET /api/decks` - è·å–ç‰Œç»„åˆ—è¡¨
- `POST /api/decks` - åˆ›å»ºæ–°ç‰Œç»„

### 5. å‰ç«¯ UI âœ…

**å¡ç‰‡ç”Ÿæˆé¡µé¢**ï¼š`app/[locale]/cards/generate/page.tsx`
- è¾“å…¥æ—¥æ–‡å¥å­
- é€‰æ‹©å¡ç‰‡ç±»å‹å’Œç‰Œç»„
- ç”Ÿæˆé¢„è§ˆï¼ˆLLM åˆ†æ + TTSï¼‰
- ä¿å­˜å¡ç‰‡

**å¡ç‰‡ç®¡ç†é¡µé¢**ï¼š`app/[locale]/cards/page.tsx`
- å¡ç‰‡åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
- æŒ‰ç‰Œç»„ç­›é€‰
- æŸ¥çœ‹å¡ç‰‡è¯¦æƒ…
- åˆ é™¤å¡ç‰‡

### 6. å·¥å…·å‡½æ•° âœ…

**æ–‡ä»¶**ï¼š`lib/llm-utils.ts`
- `extractKanaFromLLMResult()` - ä» LLM ç»“æœä¸­æå–å‡å
- `markdownToHtml()` - Markdown è½¬ HTMLï¼ˆç”¨äºå¡ç‰‡æ˜¾ç¤ºï¼‰

---

## ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œ

### å¿…é¡»å®Œæˆï¼ˆéƒ¨ç½²å‰ï¼‰

1. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   npx prisma migrate dev --name add_cards_and_decks
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```env
   DASHSCOPE_API_KEY=your-dashscope-api-key
   ```

3. **æµ‹è¯•åŠŸèƒ½**
   - æµ‹è¯• LLM åˆ†æ API
   - æµ‹è¯• TTS ç”Ÿæˆ API
   - æµ‹è¯•å¡ç‰‡ç”Ÿæˆå’Œä¿å­˜
   - æµ‹è¯•å¡ç‰‡åˆ—è¡¨å’Œåˆ é™¤

### å¯é€‰ä¼˜åŒ–

1. **éŸ³é¢‘å­˜å‚¨ä¼˜åŒ–**
   - å½“å‰è¿”å› DashScope çš„ä¸´æ—¶ URL
   - å»ºè®®ä¸‹è½½éŸ³é¢‘å¹¶ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆS3/OSSï¼‰
   - æ›´æ–° `app/api/tts/generate-enhanced/route.ts`

2. **æ—¶é—´æˆ³å¯¹é½**
   - å½“å‰ TTS API å¯èƒ½ä¸è¿”å›æ—¶é—´æˆ³
   - éœ€è¦å®ç°æ—¶é—´æˆ³å¯¹é½åŠŸèƒ½ï¼ˆå‡å â†’ åŸæ–‡ï¼‰
   - å‚è€ƒ `anki-gpt20/dialog/generator_handler.py` ä¸­çš„ `_align_timestamps_to_original_text`

3. **æ‰¹é‡ç”ŸæˆåŠŸèƒ½**
   - å®ç°æ‰¹é‡å¤„ç†å¤šä¸ªå¥å­
   - åˆ›å»º `app/api/cards/batch/route.ts`

4. **å¡ç‰‡å¯¼å‡º**
   - å®ç°å¯¼å‡ºä¸º Anki æ ¼å¼ï¼ˆ.apkg æ–‡ä»¶ï¼‰
   - éœ€è¦å®‰è£… `anki-apkg-export` æˆ–ç±»ä¼¼åº“

5. **UI ä¼˜åŒ–**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - ä¼˜åŒ–é”™è¯¯æç¤º
   - æ·»åŠ å¡ç‰‡ç¼–è¾‘åŠŸèƒ½
   - æ·»åŠ æœç´¢åŠŸèƒ½

6. **æ€§èƒ½ä¼˜åŒ–**
   - å®ç°ç¼“å­˜æœºåˆ¶ï¼ˆç›¸åŒæ–‡æœ¬ä¸é‡å¤ç”Ÿæˆï¼‰
   - ä½¿ç”¨é˜Ÿåˆ—å¤„ç†é•¿æ—¶é—´ä»»åŠ¡ï¼ˆBullMQï¼‰

---

## ğŸ”§ ä½¿ç”¨è¯´æ˜

### 1. ç”Ÿæˆå¡ç‰‡

1. è®¿é—® `/cards/generate`
2. è¾“å…¥æ—¥æ–‡å¥å­
3. é€‰æ‹©å¡ç‰‡ç±»å‹å’Œç‰Œç»„
4. å‹¾é€‰"åŒ…å«å‘éŸ³"ï¼ˆå¯é€‰ï¼‰
5. ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"
6. é¢„è§ˆæ»¡æ„åç‚¹å‡»"ä¿å­˜å¡ç‰‡"

### 2. æŸ¥çœ‹å¡ç‰‡

1. è®¿é—® `/cards`
2. ä½¿ç”¨ç­›é€‰å™¨æŒ‰ç‰Œç»„æŸ¥çœ‹
3. ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…
4. å¯ä»¥åˆ é™¤ä¸éœ€è¦çš„å¡ç‰‡

### 3. Credit æ¶ˆè€—

- LLM åˆ†æï¼š2 credits
- TTS ç”Ÿæˆï¼š1 credit
- å®Œæ•´å¡ç‰‡ç”Ÿæˆï¼ˆå«å‘éŸ³ï¼‰ï¼š3 credits
- å®Œæ•´å¡ç‰‡ç”Ÿæˆï¼ˆä¸å«å‘éŸ³ï¼‰ï¼š2 credits

---

## ğŸ“ API æ–‡æ¡£

### POST /api/llm/analyze

**è¯·æ±‚**ï¼š
```json
{
  "text": "ã“ã‚“ã«ã¡ã¯"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "analysis": {
    "markdown": "...",
    "html": "...",
    "kanaText": "ã“ã‚“ã«ã¡ã¯"
  },
  "credits": 8
}
```

### POST /api/tts/generate-enhanced

**è¯·æ±‚**ï¼š
```json
{
  "text": "ã“ã‚“ã«ã¡ã¯",
  "kanaText": "ã“ã‚“ã«ã¡ã¯"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "audio": {
    "url": "https://..."
  },
  "credits": 7
}
```

### POST /api/cards/generate

**è¯·æ±‚**ï¼š
```json
{
  "text": "ã“ã‚“ã«ã¡ã¯",
  "cardType": "é—®ç­”é¢˜ï¼ˆé™„ç¿»è½¬å¡ç‰‡ï¼‰",
  "deckName": "default",
  "includePronunciation": true
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "card": {
    "id": "...",
    "frontContent": "ã“ã‚“ã«ã¡ã¯",
    "backContent": "...",
    "audioUrl": "https://...",
    ...
  },
  "credits": 4
}
```

---

## ğŸ› å·²çŸ¥é—®é¢˜

1. **éŸ³é¢‘ URL ä¸´æ—¶æ€§**
   - DashScope è¿”å›çš„éŸ³é¢‘ URL å¯èƒ½æ˜¯ä¸´æ—¶çš„
   - å»ºè®®ä¸‹è½½å¹¶ä¿å­˜åˆ°äº‘å­˜å‚¨

2. **æ—¶é—´æˆ³åŠŸèƒ½æœªå®ç°**
   - å½“å‰ TTS API å¯èƒ½ä¸è¿”å›æ—¶é—´æˆ³
   - éœ€è¦é¢å¤–å®ç°æ—¶é—´æˆ³å¯¹é½

3. **é”™è¯¯å¤„ç†**
   - éƒ¨åˆ†é”™è¯¯å¤„ç†å¯èƒ½ä¸å¤Ÿå®Œå–„
   - éœ€è¦æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `prisma/schema.prisma` - æ•°æ®åº“æ¨¡å‹
- `lib/llm-utils.ts` - LLM å·¥å…·å‡½æ•°
- `app/api/llm/analyze/route.ts` - LLM åˆ†æ API
- `app/api/tts/generate-enhanced/route.ts` - å¢å¼º TTS API
- `app/api/cards/generate/route.ts` - å¡ç‰‡ç”Ÿæˆ API
- `app/api/cards/route.ts` - å¡ç‰‡åˆ—è¡¨ API
- `app/api/cards/[id]/route.ts` - å¡ç‰‡è¯¦æƒ… API
- `app/api/decks/route.ts` - ç‰Œç»„ API
- `app/[locale]/cards/generate/page.tsx` - å¡ç‰‡ç”Ÿæˆé¡µé¢
- `app/[locale]/cards/page.tsx` - å¡ç‰‡ç®¡ç†é¡µé¢

---

**å®Œæˆæ—¶é—´**ï¼š2025-12-31
**çŠ¶æ€**ï¼šâœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¾…æµ‹è¯•å’Œéƒ¨ç½²

